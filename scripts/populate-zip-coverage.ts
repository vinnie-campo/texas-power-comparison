import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;
const supabase = createClient(supabaseUrl, supabaseKey);

// Texas ZIP code ranges by TDSP (approximate - covers major areas)
const TDSP_ZIP_RANGES: Record<string, string[]> = {
  'centerpoint': [
    // Houston metro area
    '77001', '77002', '77003', '77004', '77005', '77006', '77007', '77008', '77009', '77010',
    '77011', '77012', '77013', '77014', '77015', '77016', '77017', '77018', '77019', '77020',
    '77021', '77022', '77023', '77024', '77025', '77026', '77027', '77028', '77029', '77030',
    '77031', '77032', '77033', '77034', '77035', '77036', '77037', '77038', '77039', '77040',
    '77041', '77042', '77043', '77044', '77045', '77046', '77047', '77048', '77049', '77050',
    '77051', '77052', '77053', '77054', '77055', '77056', '77057', '77058', '77059', '77060',
    '77061', '77062', '77063', '77064', '77065', '77066', '77067', '77068', '77069', '77070',
    '77071', '77072', '77073', '77074', '77075', '77076', '77077', '77078', '77079', '77080',
    '77081', '77082', '77083', '77084', '77085', '77086', '77087', '77088', '77089', '77090',
    '77091', '77092', '77093', '77094', '77095', '77096', '77097', '77098', '77099',
    // Surrounding areas
    '77301', '77302', '77303', '77304', '77305', '77306', // Conroe
    '77339', '77340', '77341', // Kingwood
    '77345', '77346', // Humble/Atascocita
    '77354', '77355', '77356', // Magnolia
    '77365', '77373', '77375', '77377', '77379', '77380', '77381', '77382', '77383', '77384', '77385', '77386', '77387', '77388', '77389', // The Woodlands/Spring
    '77401', '77402', // Bellaire
    '77406', '77407', // Richmond
    '77429', '77430', '77433', // Cypress
    '77449', '77450', '77451', // Katy
    '77469', '77471', // Rosenberg
    '77478', '77479', // Sugar Land
    '77484', // Waller
    '77489', // Missouri City
    '77494', '77493', '77492', // Katy
    '77501', '77502', '77503', '77504', '77505', '77506', '77507', '77508', // Pasadena
    '77510', '77511', '77512', // Santa Fe
    '77514', '77515', // Angleton
    '77517', '77518', // Santa Fe/Dickinson
    '77520', '77521', '77522', '77523', // Baytown
    '77530', '77531', '77532', // Channelview/Clute
    '77536', // Deer Park
    '77539', // Dickinson
    '77545', '77546', '77547', // Friendswood
    '77550', '77551', '77552', '77553', '77554', '77555', // Galveston
    '77562', '77563', // Highlands/Hitchcock
    '77565', '77566', // Kemah/Lake Jackson
    '77568', // La Marque
    '77571', '77572', '77573', '77574', // La Porte/League City
    '77577', '77578', // Liverpool/Manvel
    '77581', '77582', '77583', '77584', '77585', '77586', // Pearland/Seabrook
    '77590', '77591', '77592', // Texas City
    '77598', // Webster
  ],
  'oncor': [
    // Dallas
    '75201', '75202', '75203', '75204', '75205', '75206', '75207', '75208', '75209', '75210',
    '75211', '75212', '75214', '75215', '75216', '75217', '75218', '75219', '75220',
    '75221', '75222', '75223', '75224', '75225', '75226', '75227', '75228', '75229', '75230',
    '75231', '75232', '75233', '75234', '75235', '75236', '75237', '75238', '75239', '75240',
    '75241', '75242', '75243', '75244', '75245', '75246', '75247', '75248', '75249', '75250',
    '75251', '75252', '75253', '75254',
    // Fort Worth
    '76101', '76102', '76103', '76104', '76105', '76106', '76107', '76108', '76109', '76110',
    '76111', '76112', '76113', '76114', '76115', '76116', '76117', '76118', '76119', '76120',
    '76121', '76122', '76123', '76124', '76126', '76127', '76129', '76130', '76131', '76132',
    '76133', '76134', '76135', '76136', '76137',
    // Arlington
    '76001', '76002', '76003', '76004', '76005', '76006', '76007', '76010', '76011', '76012',
    '76013', '76014', '76015', '76016', '76017', '76018', '76019',
    // Plano
    '75023', '75024', '75025', '75026', '75074', '75075', '75086', '75093', '75094',
    // Irving
    '75014', '75015', '75016', '75017', '75038', '75039', '75060', '75061', '75062', '75063',
    // Garland
    '75040', '75041', '75042', '75043', '75044', '75045', '75046', '75047', '75048', '75049',
    // Mesquite
    '75149', '75150', '75180', '75181', '75182', '75185',
    // Frisco
    '75033', '75034', '75035', '75036',
    // McKinney
    '75069', '75070', '75071', '75072',
    // Denton
    '76201', '76202', '76203', '76204', '76205', '76206', '76207', '76208', '76209', '76210',
    // Carrollton
    '75006', '75007', '75010', '75011',
    // Lewisville
    '75027', '75028', '75029', '75056', '75057', '75067',
    // Richardson
    '75080', '75081', '75082', '75083', '75085',
    // Grand Prairie
    '75050', '75051', '75052', '75053', '75054',
    // Waco area
    '76701', '76702', '76703', '76704', '76705', '76706', '76707', '76708', '76710', '76711', '76712',
    // Additional DFW suburbs
    '75001', '75002', '75009', '75013', '75019', '75030', '75032', '75037', 
    '75043', '75044', '75048', '75052', '75054', '75056', '75057', '75058',
    '75068', '75069', '75071', '75074', '75075', '75077', '75078', '75080',
    '75081', '75082', '75087', '75088', '75089', '75093', '75094', '75098',
    '75104', '75115', '75116', '75125', '75126', '75134', '75137', '75141',
    '75142', '75143', '75146', '75149', '75150', '75154', '75159', '75160',
    '75165', '75166', '75167', '75172', '75180', '75181', '75182', '75189',
  ],
  'aep-central': [
    // Corpus Christi
    '78401', '78402', '78403', '78404', '78405', '78406', '78407', '78408', '78409', '78410',
    '78411', '78412', '78413', '78414', '78415', '78416', '78417', '78418', '78419',
    // McAllen/Rio Grande Valley
    '78501', '78502', '78503', '78504', '78505', // McAllen
    '78516', '78520', '78521', '78522', '78523', // Brownsville
    '78526', '78535', '78537', '78538', '78539', // Harlingen/La Feria
    '78540', '78541', '78542', '78543', // Hidalgo/Edinburg
    '78550', '78551', '78552', '78553', // Harlingen
    '78557', '78558', '78559', '78560', // Hidalgo
    '78561', '78562', '78563', '78564', '78565', '78566', '78567', '78568', '78569',
    '78570', '78572', '78573', '78574', '78575', '78576', '78577', '78578', '78579',
    '78580', '78582', '78583', '78584', '78585', '78586', '78588', '78589',
    '78590', '78591', '78592', '78593', '78594', '78595', '78596', '78597', '78598', '78599',
    // Laredo
    '78040', '78041', '78042', '78043', '78044', '78045', '78046',
  ],
  'aep-north': [
    // San Angelo
    '76901', '76902', '76903', '76904', '76905', '76906', '76908', '76909',
    // Midland
    '79701', '79702', '79703', '79704', '79705', '79706', '79707', '79708',
    // Odessa
    '79760', '79761', '79762', '79763', '79764', '79765', '79766', '79768', '79769',
    // Abilene
    '79601', '79602', '79603', '79604', '79605', '79606', '79607', '79608',
    // Big Spring
    '79720', '79721',
    // Additional West Texas
    '76932', '76933', '76934', '76935', '76936', '76937', '76939', '76940', '76941',
    '76943', '76945', '76950', '76951', '76953', '76955', '76957', '76958',
  ],
};

async function main() {
  console.log('ðŸ—ºï¸  Populating ZIP coverage...\n');

  // Get all active plans with their TDSP region
  const { data: plans, error } = await supabase
    .from('plans')
    .select('id, features')
    .eq('is_active', true);

  if (error || !plans) {
    console.error('Error fetching plans:', error);
    return;
  }

  console.log(`Found ${plans.length} active plans\n`);

  // Clear existing zip_coverage
  await supabase.from('zip_coverage').delete().neq('id', '00000000-0000-0000-0000-000000000000');
  console.log('Cleared existing ZIP coverage\n');

  let totalInserted = 0;

  for (const [tdspSlug, zipCodes] of Object.entries(TDSP_ZIP_RANGES)) {
    // Get plans for this TDSP
    const tdspPlans = plans.filter(p => (p.features as any)?.tdspRegion === tdspSlug);
    console.log(`${tdspSlug}: ${tdspPlans.length} plans, ${zipCodes.length} ZIP codes`);

    if (tdspPlans.length === 0) continue;

    // Insert ZIP coverage for each plan and ZIP combination
    for (const plan of tdspPlans) {
      const records = zipCodes.map(zip => ({
        plan_id: plan.id,
        zip_code: zip,
        utility_provider: tdspSlug,
      }));

      // Insert in batches of 1000
      for (let i = 0; i < records.length; i += 1000) {
        const batch = records.slice(i, i + 1000);
        const { error: insertError } = await supabase
          .from('zip_coverage')
          .upsert(batch, { onConflict: "plan_id,zip_code", ignoreDuplicates: true });

        if (insertError) {
          console.error(`  Error inserting batch:`, insertError.message);
        } else {
          totalInserted += batch.length;
        }
      }
    }
  }

  console.log(`\nâœ… Inserted ${totalInserted} ZIP coverage records`);
}

main().catch(console.error);
